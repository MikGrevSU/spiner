<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Fortune Wheel Timer</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --primary: #ff1744;
            --secondary: #00ff88;
            --bg: #0f0f1e;
            --glass: rgba(255, 255, 255, 0.07);
            --border: rgba(255, 255, 255, 0.15);
        }

        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            background: radial-gradient(circle at center, #1a1a3a 0%, #0f0f1e 100%);
            font-family: 'Segoe UI', Roboto, sans-serif;
            color: #fff;
            overflow: hidden;
        }

        .header-stats {
            width: 100%;
            padding: 20px 15px;
            display: flex;
            justify-content: space-between;
            gap: 15px;
            background: var(--glass);
            backdrop-filter: blur(15px);
            border-bottom: 1px solid var(--border);
            position: fixed;
            top: 0;
            z-index: 100;
        }

        .stat-card {
            flex: 1;
            padding: 10px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 12px;
            border: 1px solid var(--border);
            text-align: center;
        }

        .stat-label {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1px;
            opacity: 0.7;
            margin-bottom: 4px;
        }

        .stat-value {
            font-size: 20px;
            font-weight: 800;
            color: var(--secondary);
        }

        .main-container {
            margin-top: 120px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            flex-grow: 1;
            width: 100%;
            gap: 30px;
        }

        .wheel-box {
            --size: clamp(280px, 85vmin, 450px);
            position: relative;
            width: var(--size);
            height: var(--size);
        }

        .spinner {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            transition: transform 5s cubic-bezier(0.1, 0, 0, 1);
            list-style: none;
            padding: 0;
            margin: 0;
            border: 8px solid #2a2a4a;
            box-shadow: 0 0 30px rgba(0,0,0,0.5);
            position: relative;
            overflow: hidden;
        }

        .spinner::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 40px;
            height: 40px;
            background: #fff;
            border-radius: 50%;
            z-index: 5;
            border: 4px solid #2a2a4a;
        }

        .ticker {
            position: absolute;
            top: -10px;
            left: 50%;
            width: 0;
            height: 0;
            border-left: 15px solid transparent;
            border-right: 15px solid transparent;
            border-top: 35px solid var(--primary);
            z-index: 10;
            transform: translateX(-50%);
        }

        .prize {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 50%;
            height: 40px;
            margin-top: -20px;
            transform-origin: left center;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 25px;
            font-weight: 900;
            font-size: calc(var(--size) / 16);
            color: white;
            text-shadow: 1px 1px 3px rgba(0,0,0,0.8);
        }

        .bottom-ui {
            width: 100%;
            padding: 0 20px 40px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
        }

        .result {
            font-size: 24px;
            font-weight: 800;
            min-height: 32px;
            color: var(--secondary);
            text-align: center;
        }

        .btn-spin {
            width: 100%;
            max-width: 300px;
            background: linear-gradient(135deg, #ff1744 0%, #d32f2f 100%);
            color: white;
            border: none;
            padding: 20px;
            border-radius: 16px;
            font-size: 18px;
            font-weight: 800;
            cursor: pointer;
            text-transform: uppercase;
        }

        .btn-spin:disabled {
            background: #333;
            opacity: 0.8;
            font-size: 16px;
        }
    </style>
</head>
<body>

    <div class="header-stats">
        <div class="stat-card">
            <div class="stat-label">Попытки</div>
            <div class="stat-value" id="spins">0</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Баланс</div>
            <div class="stat-value" id="balance">0</div>
        </div>
    </div>

    <div class="main-container">
        <div class="wheel-box">
            <div class="ticker"></div>
            <ul class="spinner" id="spinner"></ul>
        </div>

        <div class="bottom-ui">
            <div class="result" id="result"></div>
            <button class="btn-spin" id="spin-btn">ЗАГРУЗКА...</button>
        </div>
    </div>

    <script>
        // ИЗМЕНЕНО: Используем IP твоего сервера напрямую
        const API_URL = "https://collar-weekly-trademark-lance.trycloudflare.com";
        const COOLDOWN_MS = 2 * 60 * 60 * 1000;

        const prizeConfig = [
            { value: 0, count: 13, color: "#2b2b4a" },
            { value: 50, count: 6, color: "#ff5722" },
            { value: 5000, count: 1, color: "#ffc107" },
            { value: 2000, count: 1, color: "#4caf50" },
            { value: 1500, count: 1, color: "#009688" },
            { value: 1000, count: 1, color: "#00bcd4" },
            { value: 500, count: 1, color: "#2196f3" },
            { value: 300, count: 2, color: "#3f51b5" },
            { value: 200, count: 3, color: "#673ab7" },
            { value: 100, count: 3, color: "#9c27b0" }
        ];

        const prizes = [];
        prizeConfig.forEach(p => { for (let i = 0; i < p.count; i++) prizes.push(p); });

        const numSectors = prizes.length;
        const step = 360 / numSectors;
        const spinner = document.getElementById('spinner');
        const btn = id => document.getElementById(id);

        let currentRotation = 0;
        let state = { balance: 0, lastSpinTime: 0, userId: null };

        const tg = window.Telegram.WebApp;

        function initApp() {
            tg.ready();
            tg.expand();

            // Пробуем все варианты получения ID
            let user = tg.initDataUnsafe?.user;

            // Если объект пустой, пробуем распарсить строку вручную
            if (!user && tg.initData) {
                try {
                    const params = new URLSearchParams(tg.initData);
                    user = JSON.parse(params.get('user'));
                } catch(e) { console.error("Parse error", e); }
            }

            if (user && user.id) {
                state.userId = user.id;
                loadUserData();
            } else {
                // Если мы здесь, значит Telegram вообще не прислал данные
                btn('spin-btn').textContent = "ОШИБКА ID";
                btn('result').textContent = "ЖМИ /START В БОТЕ";
                btn('spin-btn').disabled = true;

                // Выведем отладочную инфу прямо в результат (временно)
                btn('result').innerHTML = "DEBUG: " + (tg.initData ? "DATA_OK" : "NO_DATA");
            }
        }

        async function loadUserData() {
            try {
                // ИЗМЕНЕНО: Добавлен таймаут для fetch, чтобы быстрее реагировать на ошибку
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 5000);

                const res = await fetch(`${API_URL}/get_user?userId=${state.userId}`, { signal: controller.signal });
                const data = await res.json();
                state.balance = data.balance || 0;
                state.lastSpinTime = data.lastSpinTime || 0;
                updateDisplay();
            } catch (e) {
                btn('result').textContent = "СЕРВЕР НЕДОСТУПЕН";
                btn('spin-btn').textContent = "ОШИБКА";
                console.error("Load error:", e);
            }
        }

        async function saveUserData() {
            try {
                await fetch(`${API_URL}/update_balance`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        userId: state.userId,
                        balance: state.balance,
                        lastSpinTime: state.lastSpinTime
                    })
                });
            } catch (e) { console.error("Save error", e); }
        }

        function updateDisplay() {
            const now = Date.now();
            const timeLeft = COOLDOWN_MS - (now - state.lastSpinTime);
            btn('balance').textContent = state.balance;

            if (timeLeft <= 0) {
                btn('spins').textContent = "1";
                btn('spin-btn').disabled = false;
                btn('spin-btn').textContent = "КРУТИТЬ";
            } else {
                btn('spins').textContent = "0";
                btn('spin-btn').disabled = true;
                startCountdown(timeLeft);
            }
        }

        function startCountdown(ms) {
            const timerFunc = () => {
                const diff = COOLDOWN_MS - (Date.now() - state.lastSpinTime);
                if (diff <= 0) {
                    updateDisplay();
                    clearInterval(window.timerInterval);
                    return;
                }
                const h = Math.floor(diff / 3600000);
                const m = Math.floor((diff % 3600000) / 60000);
                const s = Math.floor((diff % 60000) / 1000);
                btn('spin-btn').textContent = `${h}ч ${m}м ${s}с`;
            };
            clearInterval(window.timerInterval);
            window.timerInterval = setInterval(timerFunc, 1000);
            timerFunc();
        }

        const setup = () => {
            let grad = "conic-gradient(";
            prizes.forEach((p, i) => {
                grad += `${p.color} ${i * step}deg ${(i + 1) * step}deg${i === numSectors - 1 ? '' : ','}`;
            });
            spinner.style.background = grad + ")";

            let currentIndex = 0;
            prizeConfig.forEach(config => {
                const midIndex = currentIndex + (config.count / 2);
                const li = document.createElement('li');
                li.className = 'prize';
                li.style.transform = `rotate(${midIndex * step - 90}deg)`;
                li.innerHTML = `<span>${config.value || '0'}</span>`;
                spinner.appendChild(li);
                currentIndex += config.count;
            });
        };

        btn('spin-btn').onclick = () => {
            btn('spin-btn').disabled = true;
            btn('result').textContent = "УДАЧА БЛИЗКО...";

            const extraSpins = (Math.floor(Math.random() * 5) + 7) * 360;
            const randomOffset = Math.floor(Math.random() * 360);
            currentRotation += extraSpins + randomOffset;

            spinner.style.transform = `rotate(${currentRotation}deg)`;

            setTimeout(async () => {
                const actualRotation = currentRotation % 360;
                let winningIndex = Math.floor((360 - actualRotation) % 360 / step) % numSectors;
                const prize = prizes[winningIndex];

                state.balance += prize.value;
                state.lastSpinTime = Date.now();

                await saveUserData();
                updateDisplay();

                btn('result').textContent = prize.value > 0 ? `+${prize.value} ОЧКОВ!` : "НЕ ПОВЕЗЛО";
                btn('result').style.color = prize.value > 0 ? "#00ff88" : "#ff5252";
            }, 5000);
        };

        setup();
        initApp();
    </script>
</body>
</html>
